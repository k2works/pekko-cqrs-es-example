# 作業履歴 2025-09-18

## 概要

2025-09-18の作業内容をまとめています。

この日の作業は、イベントソーシングシステムにおいて極めて重要な「イベントのバージョニング対応」を実装しました。

## 技術的背景

### イベントバージョニングの必要性

イベントソーシングシステムでは、一度永続化されたイベントは不変です。しかし、ビジネス要件の変化によりイベントの構造を変更する必要が生じることがあります。この問題に対処するため、イベントのバージョニングが不可欠です。

#### イベント進化の課題

従来のアプローチでは以下の問題がありました：

1. **スキーマ変更の困難性**: 既存のイベントと新しいイベントの両方を処理する必要がある
2. **後方互換性**: 古いイベントを読み込んで正しく処理できる必要がある
3. **前方互換性**: 将来的な変更に備えた設計が必要

### Envelope パターンの採用

従来の直接的なProtobuf定義から、Envelopeパターンに移行しました：

```protobuf
// 変更前
message UserAccountEvent {
  oneof event {
    UserAccount_CreatedEvent created = 1;
    UserAccount_RenamedEvent renamed = 2;
    UserAccount_DeletedEvent deleted = 3;
  }
}

// 変更後
message UserAccountEvent_Envelope {
  string user_account_id = 1;
  string event_type_name = 3;
  string event_type_version = 4;
  bytes payload = 5;
  google.protobuf.Timestamp occurred_at = 99;
}
```

#### Envelopeパターンの利点

1. **メタデータの分離**: イベントタイプとバージョンを明示的に管理
2. **柔軟な進化**: ペイロードを独立して進化させることが可能
3. **マイグレーション戦略**: 複数バージョンのイベントを同時にサポート
4. **デバッグの容易性**: イベントのタイプとバージョンをログから簡単に確認

### _V1 サフィックスの導入

全てのイベントクラスに`_V1`サフィックスを追加：

- `UserAccountEvent.Created` → `UserAccountEvent.Created_V1`
- `UserAccountEvent.Renamed` → `UserAccountEvent.Renamed_V1`
- `UserAccountEvent.Deleted` → `UserAccountEvent.Deleted_V1`

これにより：

- **将来のバージョン追加が容易**: `Created_V2`、`Created_V3`などを追加可能
- **明示的なバージョン管理**: コード上でどのバージョンを使用しているか明確
- **移行パスの明確化**: V1からV2への移行時の影響範囲が明確

### シリアライザの設計

新しいシリアライザは以下のパターンを実装：

```scala
// シリアライゼーション
toBinary: イベント → Envelope(type, version, payload)

// デシリアライゼーション
fromBinary: Envelope → (type, version) マッチング → イベント
```

これにより：

- **バージョン別の処理**: `(eventTypeName, eventTypeVersion)`のタプルでパターンマッチ
- **拡張性**: 新しいバージョンの追加が容易
- **エラーハンドリング**: 未知のバージョンに対する明確なエラーメッセージ

### 移行戦略

この実装により、将来的に以下のような進化が可能に：

1. **フィールド追加**: `Created_V2`で新しいフィールドを追加
2. **複数バージョンのサポート**: V1とV2を同時にサポート
3. **段階的な移行**: 新しいイベントはV2で保存、古いイベントはV1で読み込み
4. **イベントアップキャスト**: V1イベントを読み込み時にV2に変換

## コミット: 7d8f9b7

### メッセージ

```
feat: イベントのバージョニング対応を実装
UserAccountイベントにバージョン番号を追加し、将来のイベントスキーマ変更に対する
前方互換性を確保。

変更内容:
- UserAccountEventの各イベントクラスに_V1サフィックスを追加
- Protobuf定義をバージョン対応に更新
- シリアライザーでバージョン別のイベント処理を実装
- アグリゲートステートでバージョン付きイベントの処理を対応
- レジストリクラスのエラーハンドリングを改善
- テストケースをバージョン付きイベントに対応
```

### 変更されたファイル

- M	modules/command/domain/src/main/scala/io/github/j5ik2o/pcqrses/command/domain/users/UserAccount.scala
- M	modules/command/domain/src/main/scala/io/github/j5ik2o/pcqrses/command/domain/users/UserAccountEvent.scala
- M	modules/command/interface-adapter-event-serializer/src/main/protobuf/users/event.proto
- M	modules/command/interface-adapter-event-serializer/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountEventSerializer.scala
- M	modules/command/interface-adapter-event-serializer/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountEventSerializerSpec.scala
- M	modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateRegistry.scala
- M	modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateState.scala
- M	modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericAggregateRegistry.scala
- M	modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/ShardedUserAccountAggregateSpec.scala
- M	modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializerSpec.scala
- M	modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/test/ActorSpec.scala

### 変更内容

```diff
commit 7d8f9b7ed5366061358709366693dc83829bde56
Author: Junichi Kato <j5ik2o@gmail.com>
Date:   Thu Sep 18 23:22:08 2025 +0900

    feat: イベントのバージョニング対応を実装
    
    UserAccountイベントにバージョン番号を追加し、将来のイベントスキーマ変更に対する
    前方互換性を確保。
    
    変更内容:
    - UserAccountEventの各イベントクラスに_V1サフィックスを追加
    - Protobuf定義をバージョン対応に更新
    - シリアライザーでバージョン別のイベント処理を実装
    - アグリゲートステートでバージョン付きイベントの処理を対応
    - レジストリクラスのエラーハンドリングを改善
    - テストケースをバージョン付きイベントに対応

diff --git a/modules/command/domain/src/main/scala/io/github/j5ik2o/pcqrses/command/domain/users/UserAccount.scala b/modules/command/domain/src/main/scala/io/github/j5ik2o/pcqrses/command/domain/users/UserAccount.scala
index b609199..2f79d67 100644
--- a/modules/command/domain/src/main/scala/io/github/j5ik2o/pcqrses/command/domain/users/UserAccount.scala
+++ b/modules/command/domain/src/main/scala/io/github/j5ik2o/pcqrses/command/domain/users/UserAccount.scala
@@ -25,7 +25,7 @@ object UserAccount {
   ): (UserAccount, UserAccountEvent) =
     (
       UserAccountImpl(id, false, name, emailAddress, createdAt, updatedAt),
-      UserAccountEvent.Created(
+      UserAccountEvent.Created_V1(
         id = DomainEventId.generate(),
         entityId = id,
         name = name,
@@ -51,7 +51,7 @@ object UserAccount {
         Left(RenameError.FamilyNameSame)
       } else {
         val updated = this.copy(name = newName, updatedAt = DateTime.now())
-        val event = UserAccountEvent.Renamed(
+        val event = UserAccountEvent.Renamed_V1(
           id = DomainEventId.generate(),
           entityId = id,
           oldName = name,
@@ -66,7 +66,7 @@ object UserAccount {
         Left(DeleteError.AlreadyDeleted)
       } else {
         val updated = copy(deleted = true, updatedAt = DateTime.now())
-        val event = UserAccountEvent.Deleted(
+        val event = UserAccountEvent.Deleted_V1(
           id = DomainEventId.generate(),
           entityId = id,
           occurredAt = DateTime.now()
diff --git a/modules/command/domain/src/main/scala/io/github/j5ik2o/pcqrses/command/domain/users/UserAccountEvent.scala b/modules/command/domain/src/main/scala/io/github/j5ik2o/pcqrses/command/domain/users/UserAccountEvent.scala
index 4d34a33..f7bacaa 100644
--- a/modules/command/domain/src/main/scala/io/github/j5ik2o/pcqrses/command/domain/users/UserAccountEvent.scala
+++ b/modules/command/domain/src/main/scala/io/github/j5ik2o/pcqrses/command/domain/users/UserAccountEvent.scala
@@ -5,21 +5,23 @@ import io.github.j5ik2o.pcqrses.command.domain.support.{DomainEvent, DomainEvent
 
 enum UserAccountEvent extends DomainEvent {
   override type EntityIdType = UserAccountId
-  case Created(
+  case Created_V1(
     id: DomainEventId,
     entityId: UserAccountId,
     name: UserAccountName,
     emailAddress: EmailAddress,
     occurredAt: DateTime
   )
-  case Renamed(
+
+  case Renamed_V1(
     id: DomainEventId,
     entityId: UserAccountId,
     oldName: UserAccountName,
     newName: UserAccountName,
     occurredAt: DateTime
   )
-  case Deleted(
+
+  case Deleted_V1(
     id: DomainEventId,
     entityId: UserAccountId,
     occurredAt: DateTime
diff --git a/modules/command/interface-adapter-event-serializer/src/main/protobuf/users/event.proto b/modules/command/interface-adapter-event-serializer/src/main/protobuf/users/event.proto
index e59222b..cbb84d0 100644
--- a/modules/command/interface-adapter-event-serializer/src/main/protobuf/users/event.proto
+++ b/modules/command/interface-adapter-event-serializer/src/main/protobuf/users/event.proto
@@ -5,15 +5,15 @@ package io.github.j5ik2o.pcqrses.command.interfaceAdapter.persistence.users;
 import "google/protobuf/timestamp.proto";
 import "basic/basic.proto";
 
-message UserAccountEvent {
-  oneof event {
-    UserAccount_CreatedEvent created = 1;
-    UserAccount_RenamedEvent renamed = 2;
-    UserAccount_DeletedEvent deleted = 3;
-  }
+message UserAccountEvent_Envelope {
+  string user_account_id = 1;
+  string event_type_name = 3; // ex "UserAccountEvent.Created"
+  string event_type_version = 4; // ex "V1"
+  bytes payload = 5; // UserAccount_CreatedEvent_V1 or UserAccount_RenamedEvent_V1 or UserAccount_DeletedEvent_V1
+  google.protobuf.Timestamp occurred_at = 99;
 }
 
-message UserAccount_CreatedEvent {
+message UserAccountEvent_Created_V1 {
   string event_id = 1;
   string user_account_id = 2;
   basic.UserAccountName user_name = 3;
@@ -21,7 +21,7 @@ message UserAccount_CreatedEvent {
   google.protobuf.Timestamp occurred_at = 5;
 }
 
-message UserAccount_RenamedEvent {
+message UserAccountEvent_Renamed_V1 {
   string event_id = 1;
   string user_account_id = 2;
   basic.UserAccountName old_name = 3;
@@ -29,8 +29,8 @@ message UserAccount_RenamedEvent {
   google.protobuf.Timestamp occurred_at = 5;
 }
 
-message UserAccount_DeletedEvent {
+message UserAccountEvent_Deleted_V1 {
   string event_id = 1;
   string user_account_id = 2;
   google.protobuf.Timestamp occurred_at = 3;
-}
\ No newline at end of file
+}
diff --git a/modules/command/interface-adapter-event-serializer/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountEventSerializer.scala b/modules/command/interface-adapter-event-serializer/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountEventSerializer.scala
index 45504c5..ddbbb4e 100644
--- a/modules/command/interface-adapter-event-serializer/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountEventSerializer.scala
+++ b/modules/command/interface-adapter-event-serializer/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountEventSerializer.scala
@@ -1,99 +1,103 @@
 package io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users
 
-import io.github.j5ik2o.pcqrses.command.interfaceAdapter.persistence.users.{
-  UserAccountEvent as ProtoUserAccountEvent,
-  UserAccount_CreatedEvent,
-  UserAccount_RenamedEvent,
-  UserAccount_DeletedEvent
-}
-import io.github.j5ik2o.pcqrses.command.interfaceAdapter.persistence.basic.UserAccountName as ProtoUserAccountName
-
 import io.github.j5ik2o.pcqrses.command.domain.basic.DateTime
 import io.github.j5ik2o.pcqrses.command.domain.support.DomainEventId
-import io.github.j5ik2o.pcqrses.command.domain.users.{
-  EmailAddress as DomainEmailAddress,
-  FirstName,
-  LastName,
-  UserAccountEvent as DomainUserAccountEvent,
-  UserAccountId as DomainUserAccountId,
-  UserAccountName as DomainUserAccountName
-}
+import io.github.j5ik2o.pcqrses.command.domain.users.{FirstName, LastName, EmailAddress as DomainEmailAddress, UserAccountEvent as DomainUserAccountEvent, UserAccountId as DomainUserAccountId, UserAccountName as DomainUserAccountName}
+import io.github.j5ik2o.pcqrses.command.interfaceAdapter.persistence.basic.UserAccountName as ProtoUserAccountName
+import io.github.j5ik2o.pcqrses.command.interfaceAdapter.persistence.users.*
 import org.apache.pekko.serialization.SerializerWithStringManifest
 
 class UserAccountEventSerializer extends SerializerWithStringManifest {
 
   override def identifier: Int = 20002
 
-  override def manifest(o: AnyRef): String = {
-    o match {
-      case _: DomainUserAccountEvent.Created => "Created"
-      case _: DomainUserAccountEvent.Renamed => "Renamed"
-      case _: DomainUserAccountEvent.Deleted => "Deleted"
-    }
-  }
+  // マニフェストはEnvelope内のtype/versionと重複するため固定文字列に統一
+  override def manifest(o: AnyRef): String = "Envelope"
 
   override def toBinary(o: AnyRef): Array[Byte] = {
-    val protoEvent = o match {
-      case DomainUserAccountEvent.Created(id, entityId, name, emailAddress, occurredAt) =>
-        ProtoUserAccountEvent(
-          event = ProtoUserAccountEvent.Event.Created(
-            UserAccount_CreatedEvent(
-              eventId = id.asString,
-              userAccountId = entityId.asString,
-              userName = Some(ProtoUserAccountName(
-                name.breachEncapsulationOfFirstName.asString,
-                name.breachEncapsulationOfLastName.asString
-              )),
-              emailAddress = emailAddress.asString,
-              occurredAt = {
-                val sn = occurredAt.toSecondsAndNanos
-                Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
-              }
-            )
-          )
+    val envelope: UserAccountEvent_Envelope = o match {
+      case DomainUserAccountEvent.Created_V1(id, entityId, name, emailAddress, occurredAt) =>
+        val payload = UserAccountEvent_Created_V1(
+          eventId = id.asString,
+          userAccountId = entityId.asString,
+          userName = Some(ProtoUserAccountName(
+            name.breachEncapsulationOfFirstName.asString,
+            name.breachEncapsulationOfLastName.asString
+          )),
+          emailAddress = emailAddress.asString,
+          occurredAt = {
+            val sn = occurredAt.toSecondsAndNanos
+            Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
+          }
         )
-      case DomainUserAccountEvent.Renamed(id, entityId, oldName, newName, occurredAt) =>
-        ProtoUserAccountEvent(
-          event = ProtoUserAccountEvent.Event.Renamed(
-            UserAccount_RenamedEvent(
-              eventId = id.asString,
-              userAccountId = entityId.asString,
-              oldName = Some(ProtoUserAccountName(
-                oldName.breachEncapsulationOfFirstName.asString,
-                oldName.breachEncapsulationOfLastName.asString
-              )),
-              newName = Some(ProtoUserAccountName(
-                newName.breachEncapsulationOfFirstName.asString,
-                newName.breachEncapsulationOfLastName.asString
-              )),
-              occurredAt = {
-                val sn = occurredAt.toSecondsAndNanos
-                Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
-              }
-            )
-          )
+        UserAccountEvent_Envelope(
+          userAccountId = entityId.asString,
+          eventTypeName = "UserAccountEvent.Created",
+          eventTypeVersion = "V1",
+          payload = com.google.protobuf.ByteString.copyFrom(payload.toByteArray),
+          occurredAt = {
+            val sn = occurredAt.toSecondsAndNanos
+            Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
+          }
         )
-      case DomainUserAccountEvent.Deleted(id, entityId, occurredAt) =>
-        ProtoUserAccountEvent(
-          event = ProtoUserAccountEvent.Event.Deleted(
-            UserAccount_DeletedEvent(
-              eventId = id.asString,
-              userAccountId = entityId.asString,
-              occurredAt = {
-                val sn = occurredAt.toSecondsAndNanos
-                Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
-              }
-            )
-          )
+
+      case DomainUserAccountEvent.Renamed_V1(id, entityId, oldName, newName, occurredAt) =>
+        val payload = UserAccountEvent_Renamed_V1(
+          eventId = id.asString,
+          userAccountId = entityId.asString,
+          oldName = Some(ProtoUserAccountName(
+            oldName.breachEncapsulationOfFirstName.asString,
+            oldName.breachEncapsulationOfLastName.asString
+          )),
+          newName = Some(ProtoUserAccountName(
+            newName.breachEncapsulationOfFirstName.asString,
+            newName.breachEncapsulationOfLastName.asString
+          )),
+          occurredAt = {
+            val sn = occurredAt.toSecondsAndNanos
+            Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
+          }
+        )
+        UserAccountEvent_Envelope(
+          userAccountId = entityId.asString,
+          eventTypeName = "UserAccountEvent.Renamed",
+          eventTypeVersion = "V1",
+          payload = com.google.protobuf.ByteString.copyFrom(payload.toByteArray),
+          occurredAt = {
+            val sn = occurredAt.toSecondsAndNanos
+            Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
+          }
+        )
+
+      case DomainUserAccountEvent.Deleted_V1(id, entityId, occurredAt) =>
+        val payload = UserAccountEvent_Deleted_V1(
+          eventId = id.asString,
+          userAccountId = entityId.asString,
+          occurredAt = {
+            val sn = occurredAt.toSecondsAndNanos
+            Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
+          }
+        )
+        UserAccountEvent_Envelope(
+          userAccountId = entityId.asString,
+          eventTypeName = "UserAccountEvent.Deleted",
+          eventTypeVersion = "V1",
+          payload = com.google.protobuf.ByteString.copyFrom(payload.toByteArray),
+          occurredAt = {
+            val sn = occurredAt.toSecondsAndNanos
+            Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
+          }
         )
     }
-    protoEvent.toByteArray
+    envelope.toByteArray
   }
 
   override def fromBinary(bytes: Array[Byte], manifest: String): AnyRef = {
-    ProtoUserAccountEvent.parseFrom(bytes).event match {
-      case ProtoUserAccountEvent.Event.Created(value) =>
-        DomainUserAccountEvent.Created(
+    val envelope = UserAccountEvent_Envelope.parseFrom(bytes)
+    (envelope.eventTypeName, envelope.eventTypeVersion) match {
+      case ("UserAccountEvent.Created", "V1") =>
+        val value = UserAccountEvent_Created_V1.parseFrom(envelope.payload.toByteArray)
+        DomainUserAccountEvent.Created_V1(
           id = DomainEventId.from(value.eventId),
           entityId = DomainUserAccountId.from(value.userAccountId),
           name = DomainUserAccountName(
@@ -103,8 +107,10 @@ class UserAccountEventSerializer extends SerializerWithStringManifest {
           emailAddress = DomainEmailAddress(value.emailAddress),
           occurredAt = DateTime.fromSecondsAndNanos(value.occurredAt.get.seconds, value.occurredAt.get.nanos)
         )
-      case ProtoUserAccountEvent.Event.Renamed(value) =>
-        DomainUserAccountEvent.Renamed(
+
+      case ("UserAccountEvent.Renamed", "V1") =>
+        val value = UserAccountEvent_Renamed_V1.parseFrom(envelope.payload.toByteArray)
+        DomainUserAccountEvent.Renamed_V1(
           id = DomainEventId.from(value.eventId),
           entityId = DomainUserAccountId.from(value.userAccountId),
           oldName = DomainUserAccountName(
@@ -117,14 +123,17 @@ class UserAccountEventSerializer extends SerializerWithStringManifest {
           ),
           occurredAt = DateTime.fromSecondsAndNanos(value.occurredAt.get.seconds, value.occurredAt.get.nanos)
         )
-      case ProtoUserAccountEvent.Event.Deleted(value) =>
-        DomainUserAccountEvent.Deleted(
+
+      case ("UserAccountEvent.Deleted", "V1") =>
+        val value = UserAccountEvent_Deleted_V1.parseFrom(envelope.payload.toByteArray)
+        DomainUserAccountEvent.Deleted_V1(
           id = DomainEventId.from(value.eventId),
           entityId = DomainUserAccountId.from(value.userAccountId),
           occurredAt = DateTime.fromSecondsAndNanos(value.occurredAt.get.seconds, value.occurredAt.get.nanos)
         )
-      case ProtoUserAccountEvent.Event.Empty =>
-        throw new IllegalArgumentException("Unexpected Empty event in UserAccountEvent")
+
+      case (name, ver) =>
+        throw new IllegalArgumentException(s"Unexpected event type: name=$name, version=$ver in UserAccount_Envelope")
     }
   }
 }
diff --git a/modules/command/interface-adapter-event-serializer/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountEventSerializerSpec.scala b/modules/command/interface-adapter-event-serializer/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountEventSerializerSpec.scala
index a583c13..8f37dc7 100644
--- a/modules/command/interface-adapter-event-serializer/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountEventSerializerSpec.scala
+++ b/modules/command/interface-adapter-event-serializer/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountEventSerializerSpec.scala
@@ -10,7 +10,12 @@ import io.github.j5ik2o.pcqrses.command.domain.users.{
   UserAccountId,
   UserAccountName
 }
-import io.github.j5ik2o.pcqrses.command.interfaceAdapter.persistence.users.UserAccountEvent as ProtoUserAccountEvent
+import io.github.j5ik2o.pcqrses.command.interfaceAdapter.persistence.users.{
+  UserAccountEvent_Envelope,
+  UserAccountEvent_Created_V1,
+  UserAccountEvent_Renamed_V1,
+  UserAccountEvent_Deleted_V1
+}
 import org.scalatest.funsuite.AnyFunSuiteLike
 import org.scalatest.matchers.should.Matchers
 
@@ -29,9 +34,9 @@ class UserAccountEventSerializerSpec extends AnyFunSuiteLike with Matchers {
     val email = EmailAddress("taro.yamada@example.com")
     val occurredAt = DateTime.fromSecondsAndNanos(1710000000L, 123456789)
 
-    serializer.manifest(UserAccountEvent.Created(id, entityId, name, email, occurredAt)) shouldBe "Created"
-    serializer.manifest(UserAccountEvent.Renamed(id, entityId, name, name, occurredAt)) shouldBe "Renamed"
-    serializer.manifest(UserAccountEvent.Deleted(id, entityId, occurredAt)) shouldBe "Deleted"
+    serializer.manifest(UserAccountEvent.Created_V1(id, entityId, name, email, occurredAt)) shouldBe "Envelope"
+    serializer.manifest(UserAccountEvent.Renamed_V1(id, entityId, name, name, occurredAt)) shouldBe "Envelope"
+    serializer.manifest(UserAccountEvent.Deleted_V1(id, entityId, occurredAt)) shouldBe "Envelope"
   }
 
   test("toBinary should encode Created correctly") {
@@ -41,12 +46,15 @@ class UserAccountEventSerializerSpec extends AnyFunSuiteLike with Matchers {
     val email = EmailAddress("hanako.suzuki@example.com")
     val occurredAt = DateTime.fromSecondsAndNanos(1720000000L, 111222333)
 
-    val ev = UserAccountEvent.Created(id, entityId, name, email, occurredAt)
+    val ev = UserAccountEvent.Created_V1(id, entityId, name, email, occurredAt)
     val bytes = serializer.toBinary(ev)
-    val proto = ProtoUserAccountEvent.parseFrom(bytes)
+    val env = UserAccountEvent_Envelope.parseFrom(bytes)
+    env.userAccountId shouldBe entityId.asString
+    env.eventTypeName shouldBe "UserAccountEvent.Created"
+    env.eventTypeVersion shouldBe "V1"
+    (env.occurredAt.get.seconds, env.occurredAt.get.nanos) shouldBe occurredAt.toSecondsAndNanos
 
-    proto.event.isCreated shouldBe true
-    val c = proto.getCreated
+    val c = UserAccountEvent_Created_V1.parseFrom(env.payload.toByteArray)
     c.eventId shouldBe id.asString
     c.userAccountId shouldBe entityId.asString
     c.userName.get.firstName shouldBe name.breachEncapsulationOfFirstName.asString
@@ -62,12 +70,15 @@ class UserAccountEventSerializerSpec extends AnyFunSuiteLike with Matchers {
     val newName = UserAccountName(FirstName("Robert"), LastName("Johnson"))
     val occurredAt = DateTime.fromSecondsAndNanos(1730000000L, 222333444)
 
-    val ev = UserAccountEvent.Renamed(id, entityId, oldName, newName, occurredAt)
+    val ev = UserAccountEvent.Renamed_V1(id, entityId, oldName, newName, occurredAt)
     val bytes = serializer.toBinary(ev)
-    val proto = ProtoUserAccountEvent.parseFrom(bytes)
+    val env = UserAccountEvent_Envelope.parseFrom(bytes)
+    env.userAccountId shouldBe entityId.asString
+    env.eventTypeName shouldBe "UserAccountEvent.Renamed"
+    env.eventTypeVersion shouldBe "V1"
+    (env.occurredAt.get.seconds, env.occurredAt.get.nanos) shouldBe occurredAt.toSecondsAndNanos
 
-    proto.event.isRenamed shouldBe true
-    val r = proto.getRenamed
+    val r = UserAccountEvent_Renamed_V1.parseFrom(env.payload.toByteArray)
     r.eventId shouldBe id.asString
     r.userAccountId shouldBe entityId.asString
     r.oldName.get.firstName shouldBe oldName.breachEncapsulationOfFirstName.asString
@@ -82,22 +93,25 @@ class UserAccountEventSerializerSpec extends AnyFunSuiteLike with Matchers {
     val entityId = UserAccountId.generate()
     val occurredAt = DateTime.fromSecondsAndNanos(1740000000L, 333444555)
 
-    val ev = UserAccountEvent.Deleted(id, entityId, occurredAt)
+    val ev = UserAccountEvent.Deleted_V1(id, entityId, occurredAt)
     val bytes = serializer.toBinary(ev)
-    val proto = ProtoUserAccountEvent.parseFrom(bytes)
+    val env = UserAccountEvent_Envelope.parseFrom(bytes)
+    env.userAccountId shouldBe entityId.asString
+    env.eventTypeName shouldBe "UserAccountEvent.Deleted"
+    env.eventTypeVersion shouldBe "V1"
+    (env.occurredAt.get.seconds, env.occurredAt.get.nanos) shouldBe occurredAt.toSecondsAndNanos
 
-    proto.event.isDeleted shouldBe true
-    val d = proto.getDeleted
+    val d = UserAccountEvent_Deleted_V1.parseFrom(env.payload.toByteArray)
     d.eventId shouldBe id.asString
     d.userAccountId shouldBe entityId.asString
     (d.occurredAt.get.seconds, d.occurredAt.get.nanos) shouldBe occurredAt.toSecondsAndNanos
   }
 
   test("fromBinary should fail on Empty event") {
-    val empty = ProtoUserAccountEvent().toByteArray
+    val empty = UserAccountEvent_Envelope().toByteArray
     val ex = intercept[IllegalArgumentException] {
       serializer.fromBinary(empty, "")
     }
-    ex.getMessage should include("Unexpected Empty event in UserAccountEvent")
+    ex.getMessage should include("Unexpected event type")
   }
 }
diff --git a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateRegistry.scala b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateRegistry.scala
index 47c386d..ea1a26d 100644
--- a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateRegistry.scala
+++ b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateRegistry.scala
@@ -9,6 +9,7 @@ import scala.concurrent.duration.FiniteDuration
 import scala.util.Try
 
 object UserAccountAggregateRegistry {
+
   /**
    * 停止用の特別なUserAccountId（ULIDのゼロ値を使用）
    */
@@ -18,10 +19,10 @@ object UserAccountAggregateRegistry {
    * モードに応じたBehaviorを作成 呼び出し側がspawnのタイミングとアクター名を制御できる
    */
   def create(
-              mode: GenericAggregateRegistry.Mode = GenericAggregateRegistry.Mode.LocalMode,
-              idleTimeout: Option[FiniteDuration] = None,
-              enablePassivation: Boolean = true
-            )(implicit system: ActorSystem[?]): Behavior[UserAccountProtocol.Command] =
+    mode: GenericAggregateRegistry.Mode = GenericAggregateRegistry.Mode.LocalMode,
+    idleTimeout: Option[FiniteDuration] = None,
+    enablePassivation: Boolean = true
+  )(implicit system: ActorSystem[?]): Behavior[UserAccountProtocol.Command] =
     GenericAggregateRegistry.create[UserAccountId, UserAccountProtocol.Command](
       aggregateName = UserAccountId.EntityTypeName,
       mode = mode,
diff --git a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateState.scala b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateState.scala
index 45937ca..fc31f83 100644
--- a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateState.scala
+++ b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateState.scala
@@ -8,11 +8,11 @@ private[users] enum UserAccountAggregateState {
   case Deleted(user: UserAccount) // 削除状態でも全情報を保持
 
   def applyEvent(event: UserAccountEvent): UserAccountAggregateState = (this, event) match {
-    case (NotCreated(id), UserAccountEvent.Created(_, entityId, name, emailAddress, _))
+    case (NotCreated(id), UserAccountEvent.Created_V1(_, entityId, name, emailAddress, _))
         if id == entityId =>
       Created(UserAccount(entityId, name, emailAddress)._1)
 
-    case (Created(user), UserAccountEvent.Renamed(_, entityId, _, newName, _))
+    case (Created(user), UserAccountEvent.Renamed_V1(_, entityId, _, newName, _))
         if user.id == entityId =>
       Created(user.rename(newName) match {
         case Right((u, _)) => u
@@ -20,7 +20,7 @@ private[users] enum UserAccountAggregateState {
           throw new IllegalStateException(s"Failed to rename user: $error")
       })
 
-    case (Created(user), UserAccountEvent.Deleted(_, entityId, _)) if user.id == entityId =>
+    case (Created(user), UserAccountEvent.Deleted_V1(_, entityId, _)) if user.id == entityId =>
       Deleted(user.delete match {
         case Right((deletedUser, _)) => deletedUser
         case Left(error) =>
diff --git a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericAggregateRegistry.scala b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericAggregateRegistry.scala
index 6c1c7a0..f5a9c84 100644
--- a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericAggregateRegistry.scala
+++ b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericAggregateRegistry.scala
@@ -61,7 +61,8 @@ object GenericAggregateRegistry {
     mode match {
       case Mode.LocalMode =>
         // ローカルモード：GenericLocalRegistryを使用
-        GenericLocalAggregateRegistry.create[ID, CMD](s"$aggregateName-registry")(nameF)(aggregateBehavior)
+        GenericLocalAggregateRegistry.create[ID, CMD](s"$aggregateName-registry")(nameF)(
+          aggregateBehavior)
 
       case Mode.ClusterMode =>
         // クラスターモード：GenericClusterRegistryを使用
diff --git a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/ShardedUserAccountAggregateSpec.scala b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/ShardedUserAccountAggregateSpec.scala
index 4a81350..6e27011 100644
--- a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/ShardedUserAccountAggregateSpec.scala
+++ b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/ShardedUserAccountAggregateSpec.scala
@@ -2,8 +2,14 @@ package io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users
 
 import com.typesafe.config.{Config, ConfigFactory}
 import io.github.j5ik2o.pcqrses.command.domain.users.UserAccountId
-import io.github.j5ik2o.pcqrses.command.interfaceAdapter.contract.users.UserAccountProtocol.{Command, CreateReply}
-import io.github.j5ik2o.pcqrses.command.interfaceAdapter.registry.{GenericAggregateRegistry, GenericClusterAggregateRegistry}
+import io.github.j5ik2o.pcqrses.command.interfaceAdapter.contract.users.UserAccountProtocol.{
+  Command,
+  CreateReply
+}
+import io.github.j5ik2o.pcqrses.command.interfaceAdapter.registry.{
+  GenericAggregateRegistry,
+  GenericClusterAggregateRegistry
+}
 import io.github.j5ik2o.pcqrses.command.interfaceAdapter.test.ActorSpec
 import org.apache.pekko.actor.testkit.typed.scaladsl.TestProbe
 import org.apache.pekko.actor.typed.ActorRef
@@ -126,9 +132,8 @@ class ShardedUserAccountAggregateSpec
     userAccountId: UserAccountId,
     createCommand: UserAccountId => Command,
     probe: TestProbe[Reply]
-  ): Unit = {
+  ): Unit =
     registry ! createCommand(userAccountId)
-  }
 
   "UserAccountAggregate" - {
     "ユーザアカウントが未作成の状態" - {
@@ -217,6 +222,12 @@ private object UserAccountAggregateSpecHelper {
   import io.github.j5ik2o.pcqrses.command.interfaceAdapter.contract.users.UserAccountProtocol.*
   import io.github.j5ik2o.pcqrses.command.domain.users.*
 
-  def createCommand(id: UserAccountId, replyTo: org.apache.pekko.actor.typed.ActorRef[CreateReply]): Command =
-    Create(id, UserAccountName(FirstName("花子"), LastName("鈴木")), EmailAddress("hanako@example.com"), replyTo)
+  def createCommand(
+    id: UserAccountId,
+    replyTo: org.apache.pekko.actor.typed.ActorRef[CreateReply]): Command =
+    Create(
+      id,
+      UserAccountName(FirstName("花子"), LastName("鈴木")),
+      EmailAddress("hanako@example.com"),
+      replyTo)
 }
diff --git a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializerSpec.scala b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializerSpec.scala
index 590f24a..a7f1d45 100644
--- a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializerSpec.scala
+++ b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializerSpec.scala
@@ -100,7 +100,7 @@ class UserAccountSnapshotSerializerSpec extends AnyFreeSpec with Matchers {
       val ex = intercept[IllegalArgumentException] {
         serializer.fromBinary(emptyBytes, "")
       }
-      ex.getMessage should include ("Unexpected empty state in UserAccountSnapshot")
+      ex.getMessage should include("Unexpected empty state in UserAccountSnapshot")
     }
   }
 }
diff --git a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/test/ActorSpec.scala b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/test/ActorSpec.scala
index 2da602a..cfd82d1 100644
--- a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/test/ActorSpec.scala
+++ b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/test/ActorSpec.scala
@@ -37,20 +37,18 @@ abstract class ActorSpec(testKit: ActorTestKit)
 
   def this() = this(ActorTestKit(ActorTestKitBase.testNameFromCallStack()))
 
-  def this(config: String) = {
+  def this(config: String) =
     this(
       ActorTestKit(
         ActorTestKitBase.testNameFromCallStack(),
         ConfigFactory.parseString(config)
       )
     )
-  }
 
-  def this(config: Config) = {
+  def this(config: Config) =
     this(ActorTestKit(ActorTestKitBase.testNameFromCallStack(), config))
-  }
 
-  def this(config: Config, settings: TestKitSettings) = {
+  def this(config: Config, settings: TestKitSettings) =
     this(
       ActorTestKit(
         ActorTestKitBase.testNameFromCallStack(),
@@ -58,7 +56,6 @@ abstract class ActorSpec(testKit: ActorTestKit)
         settings
       )
     )
-  }
 
   implicit def classicSystem: ActorSystem = system.toClassic
 

```

