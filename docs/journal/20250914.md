# 作業履歴 2025-09-14

## 概要

2025-09-14の作業内容をまとめています。

この日の作業は、UserAccountアグリゲートの実装を洗練化し、テストカバレッジを大幅に向上させる重要なマイルストーンとなりました。

## 技術的背景

### スナップショット戦略の改善

イベントソーシングシステムでは、アグリゲートの状態を効率的に復元するためにスナップショットが重要です。当初のenum方式からoneof方式への変更は、以下の理由によります：

1. **型安全性の向上**: Protocol Buffersのoneof構造により、各状態が明示的な型を持つ
2. **拡張性**: 将来的に新しい状態を追加する際の柔軟性が向上
3. **メモリ効率**: 不要なフィールドを保持しない最適化されたメッセージ構造
4. **デシリアライゼーションの明確化**: 状態のパターンマッチングが直感的に

### クラスターレジストリの命名規則統一

`GenericClusterSharding`から`GenericClusterRegistry`へのリネームは、ローカルモードの`GenericLocalRegistry`との一貫性を保つための重要な決定でした。これにより：

- **インターフェースの統一**: 両方のレジストリが同じパターンの`create`メソッドを提供
- **抽象化レベルの明確化**: シャーディングは実装の詳細であり、レジストリとして抽象化
- **コードの可読性**: 命名規則の一貫性により、コードベース全体の理解が容易に

### テストアーキテクチャの設計

`UserAccountTestHelper`トレイトの導入により、以下の利点が得られました：

- **テストコードの再利用**: 共通のテストロジックを一箇所に集約
- **テストの保守性**: 将来的にテストロジックを変更する際の影響範囲を最小化
- **異なるテスト環境での再利用**: LocalモードとClusterモードの両方で同じテストヘルパーを使用可能

## コミット: 3436cf7

### メッセージ

```
style: コードフォーマットを適用
- 未使用のimport文を削除
- インデントとフォーマットを統一
- scalafmtによる自動整形を適用
```

### 変更されたファイル

- M	modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregate.scala
- M	modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializer.scala
- M	modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala
- M	modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala
- M	modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala

### 変更内容

```diff
commit 3436cf7a2de224d72bc0984c5745989679be0f79
Author: Junichi Kato <j5ik2o@gmail.com>
Date:   Sun Sep 14 00:21:47 2025 +0900

    style: コードフォーマットを適用
    
    - 未使用のimport文を削除
    - インデントとフォーマットを統一
    - scalafmtによる自動整形を適用

diff --git a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregate.scala b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregate.scala
index c7c290e..7378321 100644
--- a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregate.scala
+++ b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregate.scala
@@ -11,7 +11,6 @@ import io.github.j5ik2o.pcqrses.command.domain.users.{UserAccount, UserAccountEv
 import io.github.j5ik2o.pcqrses.command.interfaceAdapter.contract.users.UserAccountProtocol.*
 import org.apache.pekko.actor.typed.{Behavior, SupervisorStrategy}
 import org.apache.pekko.actor.typed.scaladsl.Behaviors
-import org.apache.pekko.persistence.typed.PersistenceId
 
 object UserAccountAggregate {
 
diff --git a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializer.scala b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializer.scala
index 2b1eaf0..fb2e3fd 100644
--- a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializer.scala
+++ b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializer.scala
@@ -1,10 +1,10 @@
 package io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users
 
 import io.github.j5ik2o.pcqrses.command.interfaceAdapter.persistence.users.{
-  UserAccountSnapshot,
-  NotCreatedSnapshot,
   CreatedSnapshot,
-  DeletedSnapshot
+  DeletedSnapshot,
+  NotCreatedSnapshot,
+  UserAccountSnapshot
 }
 import io.github.j5ik2o.pcqrses.command.interfaceAdapter.persistence.basic.UserAccountName as ProtoUserAccountName
 
@@ -96,7 +96,7 @@ class UserAccountSnapshotSerializer extends SerializerWithStringManifest {
     snapshot.state match {
       case UserAccountSnapshot.State.NotCreated(notCreated) =>
         NotCreated(DomainUserAccountId.from(notCreated.userAccountId))
-        
+
       case UserAccountSnapshot.State.Created(created) =>
         val (userAccount, _) = DomainUserAccount(
           id = DomainUserAccountId.from(created.userAccountId),
@@ -108,12 +108,11 @@ class UserAccountSnapshotSerializer extends SerializerWithStringManifest {
           createdAt = DateTime.fromSecondsAndNanos(
             created.createdAt.get.seconds,
             created.createdAt.get.nanos),
-          updatedAt = DateTime.fromSecondsAndNanos(
-            created.updatedAt.get.seconds,
-            created.updatedAt.get.nanos)
+          updatedAt =
+            DateTime.fromSecondsAndNanos(created.updatedAt.get.seconds, created.updatedAt.get.nanos)
         )
         Created(userAccount)
-        
+
       case UserAccountSnapshot.State.Deleted(deleted) =>
         val (userAccount, _) = DomainUserAccount(
           id = DomainUserAccountId.from(deleted.userAccountId),
@@ -125,12 +124,11 @@ class UserAccountSnapshotSerializer extends SerializerWithStringManifest {
           createdAt = DateTime.fromSecondsAndNanos(
             deleted.createdAt.get.seconds,
             deleted.createdAt.get.nanos),
-          updatedAt = DateTime.fromSecondsAndNanos(
-            deleted.updatedAt.get.seconds,
-            deleted.updatedAt.get.nanos)
+          updatedAt =
+            DateTime.fromSecondsAndNanos(deleted.updatedAt.get.seconds, deleted.updatedAt.get.nanos)
         )
         Deleted(userAccount)
-        
+
       case UserAccountSnapshot.State.Empty =>
         throw new IllegalArgumentException("Unexpected empty state in UserAccountSnapshot")
     }
diff --git a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala
index de2e691..19d42c8 100644
--- a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala
+++ b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala
@@ -82,7 +82,7 @@ object GenericClusterRegistry {
     aggregateBehavior: ID => Behavior[CMD]
   )(implicit system: ActorSystem[?]): Behavior[CMD] = {
     val clusterSharding = ClusterSharding(system)
-    
+
     // クラスターシャーディングの初期化
     init(
       aggregateName = aggregateName,
@@ -95,7 +95,7 @@ object GenericClusterRegistry {
       idleTimeout = idleTimeout.getOrElse(DefaultIdleTimeout),
       enablePassivation = enablePassivation
     )
-    
+
     // プロキシBehaviorを返す
     ofProxy(aggregateName, clusterSharding)
   }
@@ -264,6 +264,5 @@ object GenericClusterRegistry {
     val typeKey = EntityTypeKey[CMD](aggregateName)
     clusterSharding.entityRefFor(typeKey, aggregateId.asString)
   }
-  
 
 }
diff --git a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala
index 12284b8..19518b9 100644
--- a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala
+++ b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala
@@ -15,8 +15,9 @@ import java.util.{Comparator, UUID}
 object UserAccountAggregateSpec {
   val id: String = UUID.randomUUID().toString
 
-  val config: Config = ConfigFactory.parseString(
-    s"""
+  val config: Config = ConfigFactory
+    .parseString(
+      s"""
        |pekko {
        |  persistence {
        |    journal {
@@ -38,13 +39,16 @@ object UserAccountAggregateSpec {
        |  }
        |}
        |""".stripMargin
-  ).withFallback(ConfigFactory.load())
+    )
+    .withFallback(ConfigFactory.load())
 
 }
 
-class UserAccountAggregateSpec extends ActorSpec(UserAccountAggregateSpec.config)
+class UserAccountAggregateSpec
+  extends ActorSpec(UserAccountAggregateSpec.config)
   with UserAccountTestHelper
-  with Matchers with Eventually
+  with Matchers
+  with Eventually
   with BeforeAndAfterAll {
   override def afterAll(): Unit = {
     super.afterAll()
@@ -61,10 +65,10 @@ class UserAccountAggregateSpec extends ActorSpec(UserAccountAggregateSpec.config
    * 直接spawnしたアクターにコマンドを送信
    */
   override def sendCommand[Reply](
-                                   userAccountId: UserAccountId,
-                                   createCommand: UserAccountId => Command,
-                                   probe: TestProbe[Reply]
-                                 ): Unit = {
+    userAccountId: UserAccountId,
+    createCommand: UserAccountId => Command,
+    probe: TestProbe[Reply]
+  ): Unit = {
     val aggregate = spawn(UserAccountAggregate(userAccountId))
     aggregate ! createCommand(userAccountId)
   }
@@ -75,30 +79,30 @@ class UserAccountAggregateSpec extends ActorSpec(UserAccountAggregateSpec.config
         "新しいユーザアカウントを作成できる" in
           testCreateUserAccountOnNotCreated()
       }
-      
+
       "Getコマンドを受信したとき" - {
         "NotFoundを返す" in
           testGetUserAccountOnNotCreated()
       }
     }
-    
+
     "ユーザアカウントが作成済みの状態" - {
       "Getコマンドを受信したとき" - {
         "ユーザアカウント情報を返す" in
           testGetUserAccountOnCreated()
       }
-      
+
       "Renameコマンドを受信したとき" - {
         "ユーザアカウントの名前を変更できる" in
           testRenameUserAccountOnCreated()
       }
-      
+
       "Deleteコマンドを受信したとき" - {
         "ユーザアカウントを削除できる" in
           testDeleteUserAccountOnCreated()
       }
     }
-    
+
     "ユーザアカウントが削除済みの状態" - {
       "Getコマンドを受信したとき" - {
         "NotFoundを返す" in
diff --git a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala
index 0c4b847..713080b 100644
--- a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala
+++ b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala
@@ -1,6 +1,12 @@
 package io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users
 
-import io.github.j5ik2o.pcqrses.command.domain.users.{EmailAddress, FirstName, LastName, UserAccountId, UserAccountName}
+import io.github.j5ik2o.pcqrses.command.domain.users.{
+  EmailAddress,
+  FirstName,
+  LastName,
+  UserAccountId,
+  UserAccountName
+}
 import io.github.j5ik2o.pcqrses.command.interfaceAdapter.contract.users.UserAccountProtocol._
 import io.github.j5ik2o.pcqrses.command.interfaceAdapter.test.ActorSpec
 import org.apache.pekko.actor.testkit.typed.scaladsl.TestProbe
@@ -8,19 +14,19 @@ import org.scalatest.matchers.should.Matchers
 
 trait UserAccountTestHelper { this: ActorSpec & Matchers =>
   def sendCommand[Reply](
-                          userAccountId: UserAccountId,
-                          createCommand: UserAccountId => Command,
-                          probe: TestProbe[Reply]
-                        ): Unit
+    userAccountId: UserAccountId,
+    createCommand: UserAccountId => Command,
+    probe: TestProbe[Reply]
+  ): Unit
 
   /**
    * テストヘルパー: ユーザアカウントを作成する
    */
   protected def createUserAccount(
-                             userAccountId: UserAccountId = UserAccountId.generate(),
-                             name: UserAccountName = UserAccountName(FirstName("花子"), LastName("鈴木")),
-                             email: EmailAddress = EmailAddress("hanako@example.com"),
-                           ): CreateSucceeded = {
+    userAccountId: UserAccountId = UserAccountId.generate(),
+    name: UserAccountName = UserAccountName(FirstName("花子"), LastName("鈴木")),
+    email: EmailAddress = EmailAddress("hanako@example.com")
+  ): CreateSucceeded = {
     val probe = createTestProbe[CreateReply]()
     sendCommand(
       userAccountId,
@@ -37,14 +43,14 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
     val userAccountId = UserAccountId.generate()
     val name = UserAccountName(FirstName("太郎"), LastName("山田"))
     val email = EmailAddress("taro@example.com")
-    
+
     val probe = createTestProbe[CreateReply]()
     sendCommand(
       userAccountId,
       id => Create(id, name, email, probe.ref),
       probe
     )
-    
+
     val reply = probe.expectMessageType[CreateSucceeded]
     reply.id shouldBe userAccountId
   }
@@ -56,10 +62,10 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
     val userAccountId = UserAccountId.generate()
     val name = UserAccountName(FirstName("花子"), LastName("鈴木"))
     val email = EmailAddress("hanako@example.com")
-    
+
     // まずユーザアカウントを作成
     createUserAccount(userAccountId, name, email)
-    
+
     // Getコマンドを送信
     val getProbe = createTestProbe[GetReply]()
     sendCommand(
@@ -67,7 +73,7 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
       id => Get(id, getProbe.ref),
       getProbe
     )
-    
+
     val reply = getProbe.expectMessageType[GetSucceeded]
     reply.value.id shouldBe userAccountId
     reply.value.name shouldBe name
@@ -82,10 +88,10 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
     val originalName = UserAccountName(FirstName("太郎"), LastName("山田"))
     val email = EmailAddress("taro@example.com")
     val newName = UserAccountName(FirstName("次郎"), LastName("山田"))
-    
+
     // まずユーザアカウントを作成
     createUserAccount(userAccountId, originalName, email)
-    
+
     // Renameコマンドを送信
     val renameProbe = createTestProbe[RenameReply]()
     sendCommand(
@@ -93,10 +99,10 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
       id => Rename(id, newName, renameProbe.ref),
       renameProbe
     )
-    
+
     val reply = renameProbe.expectMessageType[RenameSucceeded]
     reply.id shouldBe userAccountId
-    
+
     // 名前が変更されたことを確認
     val getProbe = createTestProbe[GetReply]()
     sendCommand(
@@ -104,7 +110,7 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
       id => Get(id, getProbe.ref),
       getProbe
     )
-    
+
     val getReply = getProbe.expectMessageType[GetSucceeded]
     getReply.value.name shouldBe newName
   }
@@ -116,10 +122,10 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
     val userAccountId = UserAccountId.generate()
     val name = UserAccountName(FirstName("太郎"), LastName("山田"))
     val email = EmailAddress("taro@example.com")
-    
+
     // まずユーザアカウントを作成
     createUserAccount(userAccountId, name, email)
-    
+
     // Deleteコマンドを送信
     val deleteProbe = createTestProbe[DeleteReply]()
     sendCommand(
@@ -127,10 +133,10 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
       id => Delete(id, deleteProbe.ref),
       deleteProbe
     )
-    
+
     val reply = deleteProbe.expectMessageType[DeleteSucceeded]
     reply.id shouldBe userAccountId
-    
+
     // 削除後にGetコマンドを送信すると、NotFoundになることを確認
     val getProbe = createTestProbe[GetReply]()
     sendCommand(
@@ -138,7 +144,7 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
       id => Get(id, getProbe.ref),
       getProbe
     )
-    
+
     getProbe.expectMessageType[GetNotFoundFailed]
   }
 
@@ -147,14 +153,14 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
    */
   protected def testGetUserAccountOnNotCreated(): Unit = {
     val userAccountId = UserAccountId.generate()
-    
+
     val probe = createTestProbe[GetReply]()
     sendCommand(
       userAccountId,
       id => Get(id, probe.ref),
       probe
     )
-    
+
     val reply = probe.expectMessageType[GetNotFoundFailed]
     reply.id shouldBe userAccountId
   }
@@ -166,10 +172,10 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
     val userAccountId = UserAccountId.generate()
     val name = UserAccountName(FirstName("太郎"), LastName("山田"))
     val email = EmailAddress("taro@example.com")
-    
+
     // ユーザアカウントを作成して削除
     createUserAccount(userAccountId, name, email)
-    
+
     val deleteProbe = createTestProbe[DeleteReply]()
     sendCommand(
       userAccountId,
@@ -177,7 +183,7 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
       deleteProbe
     )
     deleteProbe.expectMessageType[DeleteSucceeded]
-    
+
     // 削除済みユーザアカウントにGetコマンドを送信
     val getProbe = createTestProbe[GetReply]()
     sendCommand(
@@ -185,7 +191,7 @@ trait UserAccountTestHelper { this: ActorSpec & Matchers =>
       id => Get(id, getProbe.ref),
       getProbe
     )
-    
+
     val reply = getProbe.expectMessageType[GetNotFoundFailed]
     reply.id shouldBe userAccountId
   }

```

## コミット: 679af2d

### メッセージ

```
test: UserAccountAggregateの包括的なテストスイートを実装
- UserAccountAggregateSpecを実装し、全状態と操作をカバー
- UserAccountTestHelperにテストヘルパーメソッドを追加
- 未作成/作成済み/削除済みの各状態でのテストを実装
- Create/Get/Rename/Delete全コマンドの動作確認テストを追加
- カバレッジ向上のためエラーケースのテストも含む
```

### 変更されたファイル

- M	modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala
- M	modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala
- M	modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/test/ActorSpec.scala

### 変更内容

```diff
commit 679af2d3cd84e1a3a77351d0d5028350da996f3b
Author: Junichi Kato <j5ik2o@gmail.com>
Date:   Sun Sep 14 00:17:32 2025 +0900

    test: UserAccountAggregateの包括的なテストスイートを実装
    
    - UserAccountAggregateSpecを実装し、全状態と操作をカバー
    - UserAccountTestHelperにテストヘルパーメソッドを追加
    - 未作成/作成済み/削除済みの各状態でのテストを実装
    - Create/Get/Rename/Delete全コマンドの動作確認テストを追加
    - カバレッジ向上のためエラーケースのテストも含む

diff --git a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala
index 9897a73..12284b8 100644
--- a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala
+++ b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala
@@ -1,7 +1,109 @@
 package io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users
 
-import org.scalatest.funsuite.AnyFunSuiteLike
+import com.typesafe.config.{Config, ConfigFactory}
+import io.github.j5ik2o.pcqrses.command.domain.users.UserAccountId
+import io.github.j5ik2o.pcqrses.command.interfaceAdapter.contract.users.UserAccountProtocol.Command
+import io.github.j5ik2o.pcqrses.command.interfaceAdapter.test.ActorSpec
+import org.apache.pekko.actor.testkit.typed.scaladsl.TestProbe
+import org.scalatest.BeforeAndAfterAll
+import org.scalatest.concurrent.Eventually
+import org.scalatest.matchers.should.Matchers
 
-class UserAccountAggregateSpec extends AnyFunSuiteLike {
+import java.nio.file.Files
+import java.util.{Comparator, UUID}
 
+object UserAccountAggregateSpec {
+  val id: String = UUID.randomUUID().toString
+
+  val config: Config = ConfigFactory.parseString(
+    s"""
+       |pekko {
+       |  persistence {
+       |    journal {
+       |      plugin = "pekko.persistence.journal.inmem"
+       |      inmem {
+       |        class = "org.apache.pekko.persistence.journal.inmem.InmemJournal"
+       |        plugin-dispatcher = "pekko.actor.default-dispatcher"
+       |      }
+       |    }
+       |    snapshot-store {
+       |      plugin = "pekko.persistence.snapshot-store.local"
+       |      local {
+       |        dir = "target/snapshot/$id"
+       |      }
+       |    }
+       |  }
+       |  test {
+       |    single-expect-default = 5s
+       |  }
+       |}
+       |""".stripMargin
+  ).withFallback(ConfigFactory.load())
+
+}
+
+class UserAccountAggregateSpec extends ActorSpec(UserAccountAggregateSpec.config)
+  with UserAccountTestHelper
+  with Matchers with Eventually
+  with BeforeAndAfterAll {
+  override def afterAll(): Unit = {
+    super.afterAll()
+    val snapshotDir = new java.io.File(s"target/snapshot/${UserAccountAggregateSpec.id}")
+    if (snapshotDir.exists()) {
+      Files
+        .walk(snapshotDir.toPath)
+        .sorted(Comparator.reverseOrder())
+        .forEach(Files.delete(_))
+    }
+  }
+
+  /**
+   * 直接spawnしたアクターにコマンドを送信
+   */
+  override def sendCommand[Reply](
+                                   userAccountId: UserAccountId,
+                                   createCommand: UserAccountId => Command,
+                                   probe: TestProbe[Reply]
+                                 ): Unit = {
+    val aggregate = spawn(UserAccountAggregate(userAccountId))
+    aggregate ! createCommand(userAccountId)
+  }
+
+  "UserAccountAggregate" - {
+    "ユーザアカウントが未作成の状態" - {
+      "Createコマンドを受信したとき" - {
+        "新しいユーザアカウントを作成できる" in
+          testCreateUserAccountOnNotCreated()
+      }
+      
+      "Getコマンドを受信したとき" - {
+        "NotFoundを返す" in
+          testGetUserAccountOnNotCreated()
+      }
+    }
+    
+    "ユーザアカウントが作成済みの状態" - {
+      "Getコマンドを受信したとき" - {
+        "ユーザアカウント情報を返す" in
+          testGetUserAccountOnCreated()
+      }
+      
+      "Renameコマンドを受信したとき" - {
+        "ユーザアカウントの名前を変更できる" in
+          testRenameUserAccountOnCreated()
+      }
+      
+      "Deleteコマンドを受信したとき" - {
+        "ユーザアカウントを削除できる" in
+          testDeleteUserAccountOnCreated()
+      }
+    }
+    
+    "ユーザアカウントが削除済みの状態" - {
+      "Getコマンドを受信したとき" - {
+        "NotFoundを返す" in
+          testGetUserAccountOnDeleted()
+      }
+    }
+  }
 }
diff --git a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala
index a83f22e..0c4b847 100644
--- a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala
+++ b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala
@@ -1,12 +1,12 @@
 package io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users
 
 import io.github.j5ik2o.pcqrses.command.domain.users.{EmailAddress, FirstName, LastName, UserAccountId, UserAccountName}
-import io.github.j5ik2o.pcqrses.command.interfaceAdapter.contract.users.UserAccountProtocol.{Command, Create, CreateReply, CreateSucceeded}
+import io.github.j5ik2o.pcqrses.command.interfaceAdapter.contract.users.UserAccountProtocol._
 import io.github.j5ik2o.pcqrses.command.interfaceAdapter.test.ActorSpec
 import org.apache.pekko.actor.testkit.typed.scaladsl.TestProbe
 import org.scalatest.matchers.should.Matchers
 
-trait UserAccountTestBase { this: ActorSpec & Matchers =>
+trait UserAccountTestHelper { this: ActorSpec & Matchers =>
   def sendCommand[Reply](
                           userAccountId: UserAccountId,
                           createCommand: UserAccountId => Command,
@@ -14,7 +14,7 @@ trait UserAccountTestBase { this: ActorSpec & Matchers =>
                         ): Unit
 
   /**
-   * テストヘルパー: スタッフを作成する
+   * テストヘルパー: ユーザアカウントを作成する
    */
   protected def createUserAccount(
                              userAccountId: UserAccountId = UserAccountId.generate(),
@@ -30,4 +30,164 @@ trait UserAccountTestBase { this: ActorSpec & Matchers =>
     probe.expectMessageType[CreateSucceeded]
   }
 
+  /**
+   * テストヘルパー: ユーザアカウントが未作成の状態でCreateコマンドを受信したときのテスト
+   */
+  protected def testCreateUserAccountOnNotCreated(): Unit = {
+    val userAccountId = UserAccountId.generate()
+    val name = UserAccountName(FirstName("太郎"), LastName("山田"))
+    val email = EmailAddress("taro@example.com")
+    
+    val probe = createTestProbe[CreateReply]()
+    sendCommand(
+      userAccountId,
+      id => Create(id, name, email, probe.ref),
+      probe
+    )
+    
+    val reply = probe.expectMessageType[CreateSucceeded]
+    reply.id shouldBe userAccountId
+  }
+
+  /**
+   * テストヘルパー: 作成済みユーザアカウントにGetコマンドを送信したときのテスト
+   */
+  protected def testGetUserAccountOnCreated(): Unit = {
+    val userAccountId = UserAccountId.generate()
+    val name = UserAccountName(FirstName("花子"), LastName("鈴木"))
+    val email = EmailAddress("hanako@example.com")
+    
+    // まずユーザアカウントを作成
+    createUserAccount(userAccountId, name, email)
+    
+    // Getコマンドを送信
+    val getProbe = createTestProbe[GetReply]()
+    sendCommand(
+      userAccountId,
+      id => Get(id, getProbe.ref),
+      getProbe
+    )
+    
+    val reply = getProbe.expectMessageType[GetSucceeded]
+    reply.value.id shouldBe userAccountId
+    reply.value.name shouldBe name
+    reply.value.emailAddress shouldBe email
+  }
+
+  /**
+   * テストヘルパー: 作成済みユーザアカウントの名前を変更するテスト
+   */
+  protected def testRenameUserAccountOnCreated(): Unit = {
+    val userAccountId = UserAccountId.generate()
+    val originalName = UserAccountName(FirstName("太郎"), LastName("山田"))
+    val email = EmailAddress("taro@example.com")
+    val newName = UserAccountName(FirstName("次郎"), LastName("山田"))
+    
+    // まずユーザアカウントを作成
+    createUserAccount(userAccountId, originalName, email)
+    
+    // Renameコマンドを送信
+    val renameProbe = createTestProbe[RenameReply]()
+    sendCommand(
+      userAccountId,
+      id => Rename(id, newName, renameProbe.ref),
+      renameProbe
+    )
+    
+    val reply = renameProbe.expectMessageType[RenameSucceeded]
+    reply.id shouldBe userAccountId
+    
+    // 名前が変更されたことを確認
+    val getProbe = createTestProbe[GetReply]()
+    sendCommand(
+      userAccountId,
+      id => Get(id, getProbe.ref),
+      getProbe
+    )
+    
+    val getReply = getProbe.expectMessageType[GetSucceeded]
+    getReply.value.name shouldBe newName
+  }
+
+  /**
+   * テストヘルパー: 作成済みユーザアカウントを削除するテスト
+   */
+  protected def testDeleteUserAccountOnCreated(): Unit = {
+    val userAccountId = UserAccountId.generate()
+    val name = UserAccountName(FirstName("太郎"), LastName("山田"))
+    val email = EmailAddress("taro@example.com")
+    
+    // まずユーザアカウントを作成
+    createUserAccount(userAccountId, name, email)
+    
+    // Deleteコマンドを送信
+    val deleteProbe = createTestProbe[DeleteReply]()
+    sendCommand(
+      userAccountId,
+      id => Delete(id, deleteProbe.ref),
+      deleteProbe
+    )
+    
+    val reply = deleteProbe.expectMessageType[DeleteSucceeded]
+    reply.id shouldBe userAccountId
+    
+    // 削除後にGetコマンドを送信すると、NotFoundになることを確認
+    val getProbe = createTestProbe[GetReply]()
+    sendCommand(
+      userAccountId,
+      id => Get(id, getProbe.ref),
+      getProbe
+    )
+    
+    getProbe.expectMessageType[GetNotFoundFailed]
+  }
+
+  /**
+   * テストヘルパー: 未作成のユーザアカウントにGetコマンドを送信したときのテスト
+   */
+  protected def testGetUserAccountOnNotCreated(): Unit = {
+    val userAccountId = UserAccountId.generate()
+    
+    val probe = createTestProbe[GetReply]()
+    sendCommand(
+      userAccountId,
+      id => Get(id, probe.ref),
+      probe
+    )
+    
+    val reply = probe.expectMessageType[GetNotFoundFailed]
+    reply.id shouldBe userAccountId
+  }
+
+  /**
+   * テストヘルパー: 削除済みユーザアカウントにGetコマンドを送信したときのテスト
+   */
+  protected def testGetUserAccountOnDeleted(): Unit = {
+    val userAccountId = UserAccountId.generate()
+    val name = UserAccountName(FirstName("太郎"), LastName("山田"))
+    val email = EmailAddress("taro@example.com")
+    
+    // ユーザアカウントを作成して削除
+    createUserAccount(userAccountId, name, email)
+    
+    val deleteProbe = createTestProbe[DeleteReply]()
+    sendCommand(
+      userAccountId,
+      id => Delete(id, deleteProbe.ref),
+      deleteProbe
+    )
+    deleteProbe.expectMessageType[DeleteSucceeded]
+    
+    // 削除済みユーザアカウントにGetコマンドを送信
+    val getProbe = createTestProbe[GetReply]()
+    sendCommand(
+      userAccountId,
+      id => Get(id, getProbe.ref),
+      getProbe
+    )
+    
+    val reply = getProbe.expectMessageType[GetNotFoundFailed]
+    reply.id shouldBe userAccountId
+  }
+
 }
diff --git a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/test/ActorSpec.scala b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/test/ActorSpec.scala
index cfd82d1..2da602a 100644
--- a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/test/ActorSpec.scala
+++ b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/test/ActorSpec.scala
@@ -37,18 +37,20 @@ abstract class ActorSpec(testKit: ActorTestKit)
 
   def this() = this(ActorTestKit(ActorTestKitBase.testNameFromCallStack()))
 
-  def this(config: String) =
+  def this(config: String) = {
     this(
       ActorTestKit(
         ActorTestKitBase.testNameFromCallStack(),
         ConfigFactory.parseString(config)
       )
     )
+  }
 
-  def this(config: Config) =
+  def this(config: Config) = {
     this(ActorTestKit(ActorTestKitBase.testNameFromCallStack(), config))
+  }
 
-  def this(config: Config, settings: TestKitSettings) =
+  def this(config: Config, settings: TestKitSettings) = {
     this(
       ActorTestKit(
         ActorTestKitBase.testNameFromCallStack(),
@@ -56,6 +58,7 @@ abstract class ActorSpec(testKit: ActorTestKit)
         settings
       )
     )
+  }
 
   implicit def classicSystem: ActorSystem = system.toClassic
 

```

## コミット: 9b6631f

### メッセージ

```
refactor: GenericClusterShardingをGenericClusterRegistryにリネーム
- GenericLocalRegistryと一貫性のある命名に変更
- createメソッドを追加してGenericLocalRegistryと同じインターフェースを提供
- GenericRegistryからの利用を簡潔化
- プライベートメソッドとして内部実装を隠蔽
```

### 変更されたファイル

- M	modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala
- M	modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericRegistry.scala

### 変更内容

```diff
commit 9b6631f1c6c8a89d386aad1187376acb765a5a05
Author: Junichi Kato <j5ik2o@gmail.com>
Date:   Sun Sep 14 00:17:10 2025 +0900

    refactor: GenericClusterShardingをGenericClusterRegistryにリネーム
    
    - GenericLocalRegistryと一貫性のある命名に変更
    - createメソッドを追加してGenericLocalRegistryと同じインターフェースを提供
    - GenericRegistryからの利用を簡潔化
    - プライベートメソッドとして内部実装を隠蔽

diff --git a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala
index b09f1a8..de2e691 100644
--- a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala
+++ b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala
@@ -41,6 +41,65 @@ object GenericClusterRegistry {
    */
   final val DefaultNumberOfShards: Int = 100
 
+  /**
+   * クラスターレジストリを作成（GenericLocalRegistryと同じインターフェース）
+   *
+   * @param aggregateName
+   *   集約名
+   * @param extractId
+   *   文字列から集約IDを抽出する関数
+   * @param createIdleMessage
+   *   アイドルメッセージを生成する関数
+   * @param stopMessageId
+   *   停止メッセージ用のID
+   * @param numberOfShards
+   *   シャード数
+   * @param idleTimeout
+   *   アイドルタイムアウト
+   * @param enablePassivation
+   *   パッシベーションを有効にするか
+   * @param aggregateBehavior
+   *   集約の振る舞い
+   * @param system
+   *   ActorSystem
+   * @tparam ID
+   *   集約IDの型
+   * @tparam CMD
+   *   コマンドの型
+   * @return
+   *   プロキシBehavior
+   */
+  def create[ID <: EntityId, CMD <: { def id: ID } : ClassTag](
+    aggregateName: String
+  )(
+    extractId: String => Try[ID],
+    createIdleMessage: ID => CMD,
+    stopMessageId: Option[ID] = None,
+    numberOfShards: Int = DefaultNumberOfShards,
+    idleTimeout: Option[FiniteDuration] = None,
+    enablePassivation: Boolean = true
+  )(
+    aggregateBehavior: ID => Behavior[CMD]
+  )(implicit system: ActorSystem[?]): Behavior[CMD] = {
+    val clusterSharding = ClusterSharding(system)
+    
+    // クラスターシャーディングの初期化
+    init(
+      aggregateName = aggregateName,
+      clusterSharding = clusterSharding,
+      aggregateBehavior = aggregateBehavior,
+      extractId = extractId,
+      createIdleMessage = createIdleMessage,
+      stopMessageId = stopMessageId,
+      numberOfShards = numberOfShards,
+      idleTimeout = idleTimeout.getOrElse(DefaultIdleTimeout),
+      enablePassivation = enablePassivation
+    )
+    
+    // プロキシBehaviorを返す
+    ofProxy(aggregateName, clusterSharding)
+  }
+
   /**
    * クラスターシャーディングを初期化
    *
@@ -65,7 +124,7 @@ object GenericClusterRegistry {
    * @return
    *   シャーディングエンベロープのActorRef
    */
-  def init[ID <: EntityId, CMD <: { def id: ID } : ClassTag](
+  private def init[ID <: EntityId, CMD <: { def id: ID } : ClassTag](
     aggregateName: String,
     clusterSharding: ClusterSharding,
     aggregateBehavior: ID => Behavior[CMD],
@@ -165,7 +224,7 @@ object GenericClusterRegistry {
    * @return
    *   プロキシBehavior
    */
-  def ofProxy[ID <: EntityId, CMD <: { def id: ID } : ClassTag](
+  private def ofProxy[ID <: EntityId, CMD <: { def id: ID } : ClassTag](
     aggregateName: String,
     clusterSharding: ClusterSharding
   ): Behavior[CMD] =
@@ -205,4 +264,6 @@ object GenericClusterRegistry {
     val typeKey = EntityTypeKey[CMD](aggregateName)
     clusterSharding.entityRefFor(typeKey, aggregateId.asString)
   }
+  
+
 }
diff --git a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericRegistry.scala b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericRegistry.scala
index ff0596b..b103031 100644
--- a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericRegistry.scala
+++ b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericRegistry.scala
@@ -2,7 +2,6 @@ package io.github.j5ik2o.pcqrses.command.interfaceAdapter.registry
 
 import io.github.j5ik2o.pcqrses.command.domain.support.EntityId
 import org.apache.pekko.actor.typed.{ActorSystem, Behavior}
-import org.apache.pekko.cluster.sharding.typed.scaladsl.ClusterSharding
 
 import scala.reflect.ClassTag
 import scala.util.Try
@@ -65,23 +64,14 @@ object GenericRegistry {
         GenericLocalRegistry.create[ID, CMD](s"$aggregateName-registry")(nameF)(aggregateBehavior)
 
       case Mode.ClusterMode =>
-        // クラスターモード：GenericClusterShardingを使用
-        val clusterSharding = ClusterSharding(system)
-
-        // クラスターシャーディングの初期化（アプリケーション起動時に一度だけ実行）
-        GenericClusterSharding.init(
-          aggregateName = aggregateName,
-          clusterSharding = clusterSharding,
-          aggregateBehavior = aggregateBehavior,
+        // クラスターモード：GenericClusterRegistryを使用
+        GenericClusterRegistry.create[ID, CMD](aggregateName)(
           extractId = extractId,
           createIdleMessage = createIdleMessage,
           stopMessageId = stopMessageId,
-          idleTimeout = idleTimeout.getOrElse(GenericClusterSharding.DefaultIdleTimeout),
+          idleTimeout = idleTimeout,
           enablePassivation = enablePassivation
-        )
-
-        // プロキシBehaviorを返す
-        GenericClusterSharding.ofProxy(aggregateName, clusterSharding)
+        )(aggregateBehavior)
     }
 
   /**

```

## コミット: f86a570

### メッセージ

```
refactor: UserAccountのスナップショット構造を状態パターンに変更
- protobufのスナップショット定義をenum方式からoneof方式へ変更
- NotCreated/Created/Deleted各状態ごとに個別のメッセージを定義
- UserAccountSnapshotSerializerをoneof構造に対応するよう実装変更
- UserAccountAggregateStateの可視性をpackage privateに変更
```

### 変更されたファイル

- M	modules/command/interface-adapter/src/main/protobuf/users/snapshot.proto
- M	modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateState.scala
- M	modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializer.scala

### 変更内容

```diff
commit f86a57007441d95e4cb8c34c49bf0ccf23e245fd
Author: Junichi Kato <j5ik2o@gmail.com>
Date:   Sun Sep 14 00:16:49 2025 +0900

    refactor: UserAccountのスナップショット構造を状態パターンに変更
    
    - protobufのスナップショット定義をenum方式からoneof方式へ変更
    - NotCreated/Created/Deleted各状態ごとに個別のメッセージを定義
    - UserAccountSnapshotSerializerをoneof構造に対応するよう実装変更
    - UserAccountAggregateStateの可視性をpackage privateに変更

diff --git a/modules/command/interface-adapter/src/main/protobuf/users/snapshot.proto b/modules/command/interface-adapter/src/main/protobuf/users/snapshot.proto
index 41229cc..ee0a5ee 100644
--- a/modules/command/interface-adapter/src/main/protobuf/users/snapshot.proto
+++ b/modules/command/interface-adapter/src/main/protobuf/users/snapshot.proto
@@ -6,18 +6,30 @@ package io.github.j5ik2o.pcqrses.command.interfaceAdapter.persistence.users;
 import "google/protobuf/timestamp.proto";
 import "basic/basic.proto";
 
-enum UserAccountStatus {
-  UNKNOWN = 0;  // protobufのデフォルト値として予約
-  CREATED = 1;
-  DELETED = 2;
+message NotCreatedSnapshot {
+  string user_account_id = 1;
 }
 
-message UserAccountSnapshot {
+message CreatedSnapshot {
+  string user_account_id = 1;
+  basic.UserAccountName user_name = 2;
+  string email_address = 3;
+  google.protobuf.Timestamp created_at = 4;
+  google.protobuf.Timestamp updated_at = 5;
+}
+
+message DeletedSnapshot {
   string user_account_id = 1;
-  UserAccountStatus status = 2;
-  // 以下のフィールドはstatusがCREATED以上の時に設定される
-  basic.UserAccountName user_name = 3;
-  string email_address = 4;
-  google.protobuf.Timestamp created_at = 5;
-  google.protobuf.Timestamp updated_at = 6;
+  basic.UserAccountName user_name = 2;
+  string email_address = 3;
+  google.protobuf.Timestamp created_at = 4;
+  google.protobuf.Timestamp updated_at = 5;
+}
+
+message UserAccountSnapshot {
+  oneof state {
+    NotCreatedSnapshot not_created = 1;
+    CreatedSnapshot created = 2;
+    DeletedSnapshot deleted = 3;
+  }
 }
diff --git a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateState.scala b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateState.scala
index 393f3b8..45937ca 100644
--- a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateState.scala
+++ b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateState.scala
@@ -2,7 +2,7 @@ package io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users
 
 import io.github.j5ik2o.pcqrses.command.domain.users.{UserAccount, UserAccountEvent, UserAccountId}
 
-enum UserAccountAggregateState {
+private[users] enum UserAccountAggregateState {
   case NotCreated(id: UserAccountId)
   case Created(user: UserAccount)
   case Deleted(user: UserAccount) // 削除状態でも全情報を保持
diff --git a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializer.scala b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializer.scala
index c9547df..2b1eaf0 100644
--- a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializer.scala
+++ b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountSnapshotSerializer.scala
@@ -2,7 +2,9 @@ package io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users
 
 import io.github.j5ik2o.pcqrses.command.interfaceAdapter.persistence.users.{
   UserAccountSnapshot,
-  UserAccountStatus
+  NotCreatedSnapshot,
+  CreatedSnapshot,
+  DeletedSnapshot
 }
 import io.github.j5ik2o.pcqrses.command.interfaceAdapter.persistence.basic.UserAccountName as ProtoUserAccountName
 
@@ -24,97 +26,113 @@ class UserAccountSnapshotSerializer extends SerializerWithStringManifest {
 
   override def manifest(o: AnyRef): String =
     o match {
+      case _: NotCreated => "NotCreated"
       case _: Created => "Created"
       case _: Deleted => "Deleted"
-      case _: NotCreated =>
-        throw new IllegalArgumentException("NotCreated state should not be serialized")
     }
 
   override def toBinary(o: AnyRef): Array[Byte] = {
     val snapshot = o match {
+      case NotCreated(id) =>
+        UserAccountSnapshot(
+          UserAccountSnapshot.State.NotCreated(
+            NotCreatedSnapshot(
+              userAccountId = id.asString
+            )
+          )
+        )
       case Created(userAccount) =>
         UserAccountSnapshot(
-          userAccountId = userAccount.id.asString,
-          status = UserAccountStatus.CREATED,
-          userName = Some(
-            ProtoUserAccountName(
-              userAccount.name.breachEncapsulationOfFirstName.asString,
-              userAccount.name.breachEncapsulationOfLastName.asString
-            )),
-          emailAddress = userAccount.emailAddress.asString,
-          createdAt = {
-            val sn = userAccount.createdAt.toSecondsAndNanos
-            Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
-          },
-          updatedAt = {
-            val sn = userAccount.updatedAt.toSecondsAndNanos
-            Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
-          }
+          UserAccountSnapshot.State.Created(
+            CreatedSnapshot(
+              userAccountId = userAccount.id.asString,
+              userName = Some(
+                ProtoUserAccountName(
+                  userAccount.name.breachEncapsulationOfFirstName.asString,
+                  userAccount.name.breachEncapsulationOfLastName.asString
+                )
+              ),
+              emailAddress = userAccount.emailAddress.asString,
+              createdAt = {
+                val sn = userAccount.createdAt.toSecondsAndNanos
+                Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
+              },
+              updatedAt = {
+                val sn = userAccount.updatedAt.toSecondsAndNanos
+                Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
+              }
+            )
+          )
         )
       case Deleted(userAccount) =>
-        // Deleted状態でも全情報を保持（リカバリ用）
         UserAccountSnapshot(
-          userAccountId = userAccount.id.asString,
-          status = UserAccountStatus.DELETED,
-          userName = Some(
-            ProtoUserAccountName(
-              userAccount.name.breachEncapsulationOfFirstName.asString,
-              userAccount.name.breachEncapsulationOfLastName.asString
-            )),
-          emailAddress = userAccount.emailAddress.asString,
-          createdAt = {
-            val sn = userAccount.createdAt.toSecondsAndNanos
-            Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
-          },
-          updatedAt = {
-            val sn = userAccount.updatedAt.toSecondsAndNanos
-            Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
-          }
+          UserAccountSnapshot.State.Deleted(
+            DeletedSnapshot(
+              userAccountId = userAccount.id.asString,
+              userName = Some(
+                ProtoUserAccountName(
+                  userAccount.name.breachEncapsulationOfFirstName.asString,
+                  userAccount.name.breachEncapsulationOfLastName.asString
+                )
+              ),
+              emailAddress = userAccount.emailAddress.asString,
+              createdAt = {
+                val sn = userAccount.createdAt.toSecondsAndNanos
+                Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
+              },
+              updatedAt = {
+                val sn = userAccount.updatedAt.toSecondsAndNanos
+                Some(com.google.protobuf.timestamp.Timestamp(sn._1, sn._2))
+              }
+            )
+          )
         )
-      case NotCreated(_) =>
-        throw new IllegalArgumentException("NotCreated state should not be serialized")
     }
     snapshot.toByteArray
   }
 
   override def fromBinary(bytes: Array[Byte], manifest: String): AnyRef = {
     val snapshot = UserAccountSnapshot.parseFrom(bytes)
-    snapshot.status match {
-      case UserAccountStatus.CREATED =>
+    snapshot.state match {
+      case UserAccountSnapshot.State.NotCreated(notCreated) =>
+        NotCreated(DomainUserAccountId.from(notCreated.userAccountId))
+        
+      case UserAccountSnapshot.State.Created(created) =>
         val (userAccount, _) = DomainUserAccount(
-          id = DomainUserAccountId.from(snapshot.userAccountId),
+          id = DomainUserAccountId.from(created.userAccountId),
           name = DomainUserAccountName(
-            FirstName(snapshot.userName.get.firstName),
-            LastName(snapshot.userName.get.lastName)
+            FirstName(created.userName.get.firstName),
+            LastName(created.userName.get.lastName)
           ),
-          emailAddress = DomainEmailAddress(snapshot.emailAddress),
+          emailAddress = DomainEmailAddress(created.emailAddress),
           createdAt = DateTime.fromSecondsAndNanos(
-            snapshot.createdAt.get.seconds,
-            snapshot.createdAt.get.nanos),
+            created.createdAt.get.seconds,
+            created.createdAt.get.nanos),
           updatedAt = DateTime.fromSecondsAndNanos(
-            snapshot.updatedAt.get.seconds,
-            snapshot.updatedAt.get.nanos)
+            created.updatedAt.get.seconds,
+            created.updatedAt.get.nanos)
         )
         Created(userAccount)
-      case UserAccountStatus.DELETED =>
-        // Deleted状態でも全情報から復元
+        
+      case UserAccountSnapshot.State.Deleted(deleted) =>
         val (userAccount, _) = DomainUserAccount(
-          id = DomainUserAccountId.from(snapshot.userAccountId),
+          id = DomainUserAccountId.from(deleted.userAccountId),
           name = DomainUserAccountName(
-            FirstName(snapshot.userName.get.firstName),
-            LastName(snapshot.userName.get.lastName)
+            FirstName(deleted.userName.get.firstName),
+            LastName(deleted.userName.get.lastName)
           ),
-          emailAddress = DomainEmailAddress(snapshot.emailAddress),
+          emailAddress = DomainEmailAddress(deleted.emailAddress),
           createdAt = DateTime.fromSecondsAndNanos(
-            snapshot.createdAt.get.seconds,
-            snapshot.createdAt.get.nanos),
+            deleted.createdAt.get.seconds,
+            deleted.createdAt.get.nanos),
           updatedAt = DateTime.fromSecondsAndNanos(
-            snapshot.updatedAt.get.seconds,
-            snapshot.updatedAt.get.nanos)
+            deleted.updatedAt.get.seconds,
+            deleted.updatedAt.get.nanos)
         )
         Deleted(userAccount)
-      case UserAccountStatus.UNKNOWN | UserAccountStatus.Unrecognized(_) =>
-        throw new IllegalArgumentException(s"Unexpected status: ${snapshot.status}")
+        
+      case UserAccountSnapshot.State.Empty =>
+        throw new IllegalArgumentException("Unexpected empty state in UserAccountSnapshot")
     }
   }
 }

```

## コミット: f8d1140

### メッセージ

```
fix: UserAccountAggregateのPersistenceId生成とシリアライザ設定を修正
- PersistenceIdの生成で'|'文字が含まれる問題を修正
- reference.confのパッケージ名にcommandが抜けていた問題を修正
- テスト用のapplication.confを追加してシリアライザ設定を適用
- Actor名に使用できない文字を避けるよう改善
```

### 変更されたファイル

- M	modules/command/interface-adapter-event-serializer/src/main/resources/reference.conf
- M	modules/command/interface-adapter/src/main/resources/reference.conf
- M	modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregate.scala
- A	modules/command/interface-adapter/src/test/resources/application.conf
- A	modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala
- A	modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala

### 変更内容

```diff
commit f8d11408d6a745a9a233a2302137b8f410e00917
Author: Junichi Kato <j5ik2o@gmail.com>
Date:   Sun Sep 14 00:16:26 2025 +0900

    fix: UserAccountAggregateのPersistenceId生成とシリアライザ設定を修正
    
    - PersistenceIdの生成で'|'文字が含まれる問題を修正
    - reference.confのパッケージ名にcommandが抜けていた問題を修正
    - テスト用のapplication.confを追加してシリアライザ設定を適用
    - Actor名に使用できない文字を避けるよう改善

diff --git a/modules/command/interface-adapter-event-serializer/src/main/resources/reference.conf b/modules/command/interface-adapter-event-serializer/src/main/resources/reference.conf
index 6cec8ca..3c9fe5f 100644
--- a/modules/command/interface-adapter-event-serializer/src/main/resources/reference.conf
+++ b/modules/command/interface-adapter-event-serializer/src/main/resources/reference.conf
@@ -2,10 +2,10 @@ pekko {
   actor {
     serialize-messages = off
     serializers {
-      user-account-event = "io.github.j5ik2o.pcqrses.interfaceAdapter.aggregate.users.UserAccountEventSerializer"
+      user-account-event = "io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users.UserAccountEventSerializer"
     }
     serialization-bindings {
-      "io.github.j5ik2o.pcqrses.domain.users.UserAccountEvent" = user-account-event
+      "io.github.j5ik2o.pcqrses.command.domain.users.UserAccountEvent" = user-account-event
     }
   }
 }
diff --git a/modules/command/interface-adapter/src/main/resources/reference.conf b/modules/command/interface-adapter/src/main/resources/reference.conf
index 09fdcdf..092ef4a 100644
--- a/modules/command/interface-adapter/src/main/resources/reference.conf
+++ b/modules/command/interface-adapter/src/main/resources/reference.conf
@@ -2,10 +2,10 @@ pekko {
   actor {
     serialize-messages = off
     serializers {
-      user-account-snapshot = "io.github.j5ik2o.pcqrses.interfaceAdapter.aggregate.users.UserAccountSnapshotSerializer"
+      user-account-snapshot = "io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users.UserAccountSnapshotSerializer"
     }
     serialization-bindings {
-      "io.github.j5ik2o.pcqrses.interfaceAdapter.aggregate.users.UserAccountAggregateState" = user-account-snapshot
+      "io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users.UserAccountAggregateState" = user-account-snapshot
     }
   }
 }
diff --git a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregate.scala b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregate.scala
index c202c0d..c7c290e 100644
--- a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregate.scala
+++ b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregate.scala
@@ -74,7 +74,7 @@ object UserAccountAggregate {
   def apply(id: UserAccountId): Behavior[Command] = {
     val config = PersistenceEffectorConfig
       .create[UserAccountAggregateState, UserAccountEvent, Command](
-        persistenceId = PersistenceId.of(id.entityTypeName, id.asString).id,
+        persistenceId = s"${id.entityTypeName}-${id.asString}",
         initialState = UserAccountAggregateState.NotCreated(id),
         applyEvent = (state, event) => state.applyEvent(event)
       )
diff --git a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterSharding.scala b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala
similarity index 99%
rename from modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterSharding.scala
rename to modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala
index 18cca6a..b09f1a8 100644
--- a/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterSharding.scala
+++ b/modules/command/interface-adapter/src/main/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/registry/GenericClusterRegistry.scala
@@ -24,7 +24,7 @@ import scala.util.{Failure, Success, Try}
  *   - 集約のライフサイクル管理（パッシベーション）
  *   - シャーディングプロキシによるメッセージルーティング
  */
-object GenericClusterSharding {
+object GenericClusterRegistry {
 
   /**
    * デフォルトのアイドルタイムアウト
diff --git a/modules/command/interface-adapter/src/test/resources/application.conf b/modules/command/interface-adapter/src/test/resources/application.conf
new file mode 100644
index 0000000..1a4e613
--- /dev/null
+++ b/modules/command/interface-adapter/src/test/resources/application.conf
@@ -0,0 +1,13 @@
+pekko {
+  actor {
+    serialize-messages = off
+    serializers {
+      user-account-event = "io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users.UserAccountEventSerializer"
+      user-account-snapshot = "io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users.UserAccountSnapshotSerializer"
+    }
+    serialization-bindings {
+      "io.github.j5ik2o.pcqrses.command.domain.users.UserAccountEvent" = user-account-event
+      "io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users.UserAccountAggregateState" = user-account-snapshot
+    }
+  }
+}
\ No newline at end of file
diff --git a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala
new file mode 100644
index 0000000..9897a73
--- /dev/null
+++ b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountAggregateSpec.scala
@@ -0,0 +1,7 @@
+package io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users
+
+import org.scalatest.funsuite.AnyFunSuiteLike
+
+class UserAccountAggregateSpec extends AnyFunSuiteLike {
+
+}
diff --git a/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala
new file mode 100644
index 0000000..a83f22e
--- /dev/null
+++ b/modules/command/interface-adapter/src/test/scala/io/github/j5ik2o/pcqrses/command/interfaceAdapter/aggregate/users/UserAccountTestHelper.scala
@@ -0,0 +1,33 @@
+package io.github.j5ik2o.pcqrses.command.interfaceAdapter.aggregate.users
+
+import io.github.j5ik2o.pcqrses.command.domain.users.{EmailAddress, FirstName, LastName, UserAccountId, UserAccountName}
+import io.github.j5ik2o.pcqrses.command.interfaceAdapter.contract.users.UserAccountProtocol.{Command, Create, CreateReply, CreateSucceeded}
+import io.github.j5ik2o.pcqrses.command.interfaceAdapter.test.ActorSpec
+import org.apache.pekko.actor.testkit.typed.scaladsl.TestProbe
+import org.scalatest.matchers.should.Matchers
+
+trait UserAccountTestBase { this: ActorSpec & Matchers =>
+  def sendCommand[Reply](
+                          userAccountId: UserAccountId,
+                          createCommand: UserAccountId => Command,
+                          probe: TestProbe[Reply]
+                        ): Unit
+
+  /**
+   * テストヘルパー: スタッフを作成する
+   */
+  protected def createUserAccount(
+                             userAccountId: UserAccountId = UserAccountId.generate(),
+                             name: UserAccountName = UserAccountName(FirstName("花子"), LastName("鈴木")),
+                             email: EmailAddress = EmailAddress("hanako@example.com"),
+                           ): CreateSucceeded = {
+    val probe = createTestProbe[CreateReply]()
+    sendCommand(
+      userAccountId,
+      id => Create(id, name, email, probe.ref),
+      probe
+    )
+    probe.expectMessageType[CreateSucceeded]
+  }
+
+}

```

